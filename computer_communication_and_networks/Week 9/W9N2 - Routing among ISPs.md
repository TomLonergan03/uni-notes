After dividing the internet into [[W9N1 - Large scale routing|autonomous systems]], we must then route packets between multiple ASes. Since an inter-AS routing algorithm involves multiple ASes, all ASes which want to communicate must run the same inter-AS algorithm. On the internet, all ASes run the same protocol, called the **Border Gateway Protocol (BGP)**. In BGP, a packet is routed to subnets, using [[W7N2 - Routers|routing table entries]] of the format $(x,I)$, where $x$ is a prefix (e.g. 138.16.16.68/22, which is a subnet containing 1024 addresses) and $I$ is one of the router's interfaces.
BGP has two jobs, firstly to obtain prefix reachability information from neighbouring [[W9N1 - Large scale routing|ASes]], and secondly to determine the best route to prefixes.
# Advertising BGP route information
Consider the following network consisting of 3 different ASes, and a subnet in $\text{AS3}$ with the prefix $\text{x}$:
![[w9n2bgpExampleNetwork.png]]
Every router in an AS is either an **internal router** (connects only to devices within the AS) or a **gateway router** (connects to devices in one or more other ASes). Every router in an AS maintains an **internal BGP (iBGP) connection** with every other router in that AS, and every gateway router maintains an **external BGP (eBGP) connection** with every connected router in a neighbouring AS. These connections use semi-permanent [[W5N2 - TCP|TCP]] connections using port 179. In the above network, there are eBGP connections between $\text{1c}$ and $\text{2a}$, and between $\text{2c}$ and $\text{3a}$. To propagate reachability information for subnet $\text{x}$, router $\text{3a}$ will first send a eBGP message to $\text{2c}$ that says $\text{AS3 x}$, or essentially "to reach subnet $\text{x}$ go via $\text{AS3}$". Router $\text{2c}$ then sends iBGP messages to all routers within $\text{AS2}$, and when that reaches router $\text{2a}$ it sends an eBGP message to $\text{1c}$ that says "$\text{AS2 AS3 x}$", or "route to $\text{AS2}$ then $\text{AS3}$ to reach $\text{x}$". $\text{1c}$ then sends iBGP messages to all the other routers in $\text{AS1}$.
In addition, the link from $\text{1d}$ to $\text{3d}$ means there is a second path from $\text{AS1}$ to $\text{x}$: "$\text{AS2 AS3 x}$" travelling via $\text{1c}$ and "$\text{AS3 x}$" via $\text{1d}$.
# Determining the best routes
Now that we have two routes from $\text{AS1}$ to $\text{x}$ we must be able to determine which is better in order to correctly configure routing tables. Firstly, though, there is more information attached to a BGP message. Every message contains a number of attributes, with the most important being `AS-PATH` and `NEXT-HOP`. `AS-PATH` contains the list of ASes through which the advertisement passed, while `NEXT-HOP` is the IP address of the first router outside the current AS along that path.
## Hot potato routing
The BGP routing algorithm involves **hot-potato routing**, which chooses the path with the shortest route to the `NEXT-HOP` router. This means that, using "shortest route" to mean "least hops", routers $\text{1a}$ and $\text{1d}$ would decide to route to $\text{3d}$, while routers $\text{1b}$ and $\text{1c}$ would route via $\text{2a}$. This is a selfish algorithm, which means it tries to reduce the cost in its own AS without considering the cost of the different routes in other ASes.
## BGP routing
In the simple case, BGP has only one path to select, so it chooses that one. While there are more than one option, BGP applies the following filters in order until only one remains:
1. A route has a **local preference** attribute that is assigned by the network administrator of the AS. Only routes with the highest local preference value are selected.
2. From the remaining routes, the routes with the smallest `AS-PATH` length are selected.
3. From the remaining routes, hot potato routing is used.
4. If more than one route remains, the router uses BGP identifiers to select the route. Now, when routing from $\text{1b}$ to $\text{x}$ and assuming both routes have the same local preference, packets are routed to bypass $\text{AS2}$ as that route has a shorter `AS-PATH` length. This means that BGP is not a selfish algorithm, as it considers the approximate length of a route outside the current AS, which likely leads to lower end-to-end delays.
# IP-Anycast
BGP routing allows for a simple way to route packets to the nearest server for purposes such as [[W3N7 - DNS|DNS resolution]] (despite only having 13 root DNS IPs, there are in some cases more than 100 physical servers sharing each of those IPs). If servers in different ASes use the same IP address, BGP routing will ensure that a request goes to one of the nearest servers. This is good for stateless protocols, but for TCP or other stateful protocols a BGP routing change during the connection can result in some packets being routed to a different server.
# Routing policy
The AS routing policy trumps all other considerations, which gives AS operators a lot of control over how packets are routed through their networks.
![[w9n2bgpPolicyExample.png]]
Here, $\text{A}$, $\text{B}$, and $\text{C}$ are backbone providers, while $\text{W}$, $\text{X}$, and $\text{Y}$ are access ISPs. $\text{X}$ may wish to use both $\text{B}$ and $\text{C}$ as backbone providers, but doesn't want to perform any routing between them. $\text{X}$ can achieve this by only advertising routes that end within it, which results in $\text{B}$ not being aware that $\text{X}$ can provide a route to $\text{C}$ and vice versa. Similarly, $\text{B}$ may wish to not carry packets between $\text{A}$ and $\text{C}$, and can achieve this similarly. There are no official standards governing how backbone ISPs route traffic among themselves, but usually an ISP won't carry traffic unless it either originates or is destined for a customer network. ISPs then form peering agreements between each other, which involve some form of pricing for the traffic usage, but the details and relationships are usually confidential.
